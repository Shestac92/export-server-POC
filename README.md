# export-server-POC

В одном браузере можно создать несколь контекстов с разным view-port. Каждый контекст может параллельно работать
с множеством страниц. Но тогда у них одинакоывй контекст и размеры окна.
Чтобы делать одновременно скриншоты разных размеров, то нужно либо запускать разные контексты либо прокидывать размер графика в HTML
и скринить (только нужную часть графика)[https://playwright.dev/docs/screenshots#element-screenshot]. Короче надо изучать что быстрее.

Кастомные шрифты и языки.

### Результаты нагрузки

1. Все в одной вкладке. Работает быстро, но как только кол-во запросов в секунду превышает скорость, с которой ответы отдает сервер, создается очередь и начинает сервер тонуть.

2. Каждый запрос отдельной вкладке. Это должно было по идее исключить проблему с очередью запросов. Но нет! Во-первых, это самый медленный способ,
под каждый запрос создается вкладка, а для нее весь изолированный контекст. Это занимает много времени. И результат оказался даже хуже чем в предыдущем варианте,
потому что браузер тратит кучу ресурсов на создание вкладок и контекстов, при определенной нагрузке создается по итогу очередь на создвание вкладок, потом заканчивается
память и приплыли.

Как мне кажется, нужно сделать по аналогии с Qlik тестилкой только без воркеров. Есть один браузер с N заготовленных вкладок, с уже готовым контекстом.
N вкладок определяется заранее в конфиге, так получится управлять расходом памяти. Ну и при входящем запросе на экспорт выбирается первая же свободная вкладка. Если нет, то уже да, создается очередь.

3. Оптимальным кол-вом кажется оказалось 5 вкладок. Больше просто нужно самому браузеру хендлить, а меньше не хватает.

### Исполнение пользовательского JS кода

Тут встает вопрос безопасности. Никто не хочет копрометировать свой сервер.
Однако, браузер - сама по себе изолированная среда, из браузера о сервера почти ничего не узнать и не поломать. Но можно поломать сам браузер, например,
наоткрывать кучу вкладок на левые ресурсы или использовать экспорт сервер как бота для DDoS-атак. Надо подумать как все это обезопасить,
вроде как playwright позволяет (это сделать)[https://playwright.dev/docs/network#http-authentication].

### TODO
- кастомный размер картинки
- возврат картинки в ответе
- исполнение пользовательского JS-кода, с проверкой origin!
- как альтернатива - использование шаблонов с заготовленным JS кодом, куда только данные из JSON вставляются.
  То есть клиент передает только данные и ID шаблона